#! /bin/bash
# Programming and idea by : Mohammad Hossein Salehinezhad
# Gitbub : https://github.com/mrunix1998/Openldap-over-SSL-TLS
# Email : salehimohammad331@gmail.com
# License : GPL v2.0
# Last update : Wed, 16 Mar 2022 15:56:06 +0330
# openldap.installer v1.0.0
# DO NOT USE THIS SCRIPT IN PRODUCTION ENVIRONMENT BEFORE READING LINE BY LINE
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #
# SUCCESSFULLY TESTED IN UBUNTU 20.04 [FOCAL]
# SUCCESSFULLY TESTED IN UBUNTU 18.04 [BIONIC]
# SUCCESSFULLY TESTED IN UBUNTU 16.04 [XENIAL]
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# CHECK CONFIG FILE EXIST OR NOT # ------------------------------------------------------------------------------------------------------------------------ #
[ ! -f openldap.installer.conf ] && echo "cannot access 'openldap.installer.conf': No such file or directory" && exit 1
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# READ CONFIG FILE VARIABLES # ---------------------------------------------------------------------------------------------------------------------------- #
source openldap.installer.conf
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# CONFIGURE hosts FILE # ---------------------------------------------------------------------------------------------------------------------------------- #
grep "$openldap_ip_address $openldap_domain" /etc/hosts &> /dev/null
if [ "$?" != "0" ] ; then
    echo "$openldap_ip_address $openldap_domain" >> /etc/hosts
fi
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# CREATE DISTINGUISHED NAME # ----------------------------------------------------------------------------------------------------------------------------- #
for name in $(echo "$openldap_domain" | tr '.' '\n') ; do
    if [ -z "$dc" ] ; then
        dc=$(echo "dc=$name")
    else
        dc=$(echo "$dc,dc=$name")
    fi
done
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# UPDATE PACKAGES # --------------------------------------------------------------------------------------------------------------------------------------- #
apt-get update
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# UPGRADE PACKAGES # -------------------------------------------------------------------------------------------------------------------------------------- #
apt-get -y dist-upgrade
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# CHECK RELEASE IS XENIAL OR NOT # ------------------------------------------------------------------------------------------------------------------------ #
if [ "$(lsb_release -cs)" = "xenial" ] ; then
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #


    # SET VARIABLE TO REMOE SUDO PACKAGE # ---------------------------------------------------------------------------------------------------------------- #
    export SUDO_FORCE_REMOVE=yes
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #
fi



# SET VARIABLE FOR NON INTERACTIVE PACKAGE INSTALLATION # ------------------------------------------------------------------------------------------------- #
export DEBIAN_FRONTEND=noninteractive
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# INSTALL PACKAGES # -------------------------------------------------------------------------------------------------------------------------------------- #
apt-get -y install libnss-ldap libpam-ldap ldap-utils sudo-ldap openssh-server
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# CHECK BACKUP FILE EXIST OR NOT # ------------------------------------------------------------------------------------------------------------------------ #
ls /etc/ldap.conf.*.backup &> /dev/null
if [ "$?" != "0" ] ; then
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #


    # CREATE BACKUP FROM LDAP CONFIGURATION FILE # -------------------------------------------------------------------------------------------------------- #
    cp /etc/ldap.conf /etc/ldap.conf.$RANDOM.backup
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #
fi



# ADD CONFIGURATION TO ldap.conf FILE # ------------------------------------------------------------------------------------------------------------------- #
echo "base $dc"                                   > /etc/ldap.conf
echo "uri $openldap_protocol://$openldap_domain" >> /etc/ldap.conf
echo "rootbinddn cn=$openldap_admin_user,$dc"    >> /etc/ldap.conf
echo "pam_password md5"                          >> /etc/ldap.conf
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# CONFIGURE nsswitch.conf FILE # -------------------------------------------------------------------------------------------------------------------------- #
cat /etc/nsswitch.conf | grep -v 'passwd\|group\|shadow' > /tmp/nsswitch.conf
echo 'passwd: compat systemd ldap'                      >> /tmp/nsswitch.conf
echo 'group: compat systemd ldap'                       >> /tmp/nsswitch.conf
echo 'shadow: compat'                                   >> /tmp/nsswitch.conf
echo 'sudoers: files ldap'                              >> /tmp/nsswitch.conf
mv /tmp/nsswitch.conf /etc/nsswitch.conf
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# CONFIGURE common-password FILE # ------------------------------------------------------------------------------------------------------------------------ #
sed -ei 's/\<use_authtok\>//g' /etc/pam.d/common-password &> /dev/null
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# CONFIGURE common-session FILE # ------------------------------------------------------------------------------------------------------------------------- #
echo 'session optional pam_mkhomedir.so skel=/etc/skel umask=077' >> /etc/pam.d/common-session
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# CONFIGURE sudo-ldap.conf FILE # ------------------------------------------------------------------------------------------------------------------------- #
cat /etc/sudo-ldap.conf | grep -v 'uri\|sudoers_base' > /tmp/sudo-ldap.conf
echo "uri $openldap_protocol://$openldap_domain"     >> /tmp/sudo-ldap.conf
echo "sudoers_base ou=SUDOers,$dc"                   >> /tmp/sudo-ldap.conf
mv /tmp/sudo-ldap.conf /etc/sudo-ldap.conf
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #
